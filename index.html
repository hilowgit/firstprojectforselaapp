<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ุฑุญูุฉ ุงูุจุทู ุงูุตุญู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .hero-bg {
            background-color: #F0F9FF;
            background-image: radial-gradient(#A5D8FF 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .rtl-icon { transform: scaleX(-1); }
        .hidden { display: none; }
        .view-toggle-button, .period-toggle-button {
            transition: all 0.3s ease;
        }
        .view-toggle-button.active {
            background-color: #2563EB;
            color: white;
            box-shadow: 0 4px 14px 0 rgb(37 99 235 / 39%);
        }
        .period-toggle-button.active {
            background-color: #16A34A; /* green-600 */
            color: white;
        }
        .quest-card {
             transition: all 0.3s ease;
             cursor: pointer;
        }
        .quest-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .quest-card.completed {
            background-color: #D1FAE5; /* green-100 */
            border-color: #10B981; /* green-500 */
            opacity: 0.8;
        }
        .quest-card.completed .quest-icon {
           color: #10B981; /* green-500 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/70 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-semibold text-blue-600">ุฌุงุฑู ุชุญููู ุนุงูู ุงูุฃุจุทุงู...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 hidden">
        
        <!-- Header & View Toggler -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <h1 class="text-3xl font-black text-blue-800 mb-4 md:mb-0">ุฑุญูุฉ ุงูุจุทู ุงูุตุญู</h1>
            <div class="p-1.5 bg-slate-200 rounded-full flex items-center space-x-2" dir="ltr">
                <button id="child-view-btn" class="view-toggle-button active font-bold py-2 px-6 rounded-full text-slate-700">
                    <i data-lucide="rocket" class="inline-block mr-2"></i> ุนุงูู ุงูุฃุจุทุงู
                </button>
                <button id="parent-view-btn" class="view-toggle-button font-bold py-2 px-6 rounded-full text-slate-700">
                    <i data-lucide="user-check" class="inline-block mr-2"></i> ูุฑูุฒ ุงูุฏุนู
                </button>
            </div>
        </header>

        <!-- Child View -->
        <main id="child-view">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Profile & Rewards -->
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg text-center">
                    <img src="https://placehold.co/150x150/3B82F6/FFFFFF?text=ุฑูุงู" id="avatar-img" class="mx-auto rounded-full border-4 border-blue-500 shadow-md mb-4" alt="ุตูุฑุฉ ุงูุจุทู">
                    <h2 id="child-name" class="text-2xl font-bold">ุฑูุงู</h2>
                    <div class="mt-4 flex items-center justify-center gap-2 bg-yellow-100 text-yellow-800 font-bold py-2 px-4 rounded-full text-xl">
                        <i data-lucide="star" class="text-yellow-500 fill-current"></i>
                        <span id="star-count">0</span>
                        <span>ูุฌูุฉ</span>
                    </div>
                    <p class="text-sm text-slate-500 mt-2">ุฃููู ุงูููุงู ุงูููููุฉ ูุฌูุน ุงููุฒูุฏ ูู ุงููุฌูู!</p>
                </div>

                <!-- Daily Quests -->
                <div class="lg:col-span-2">
                    <h3 class="text-2xl font-bold mb-4">ููุงูู ุงูููููุฉ ูุง ุจุทู!</h3>
                     <p class="text-sm text-slate-500 mb-4">ุงุถุบุท ุนูู ุงููููุฉ ููุนุฑูุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู.</p>
                    <div id="quests-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Quests will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Parent View -->
        <main id="parent-view" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Panel: Controls -->
                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ุชุณุฌูู ุจูุงูุงุช ุงูููู</h3>
                        <p class="text-xs text-slate-500 mb-3">ุณุฌู ุงูุจูุงูุงุช ุจุนุฏ ูู ุฒูุงุฑุฉ ููุทุจูุจ. ูุฐู ุงููุนูููุงุช ุณุฑูุฉ ูู ููุท.</p>
                        <form id="growth-form" class="space-y-3">
                            <input type="number" id="height-input" placeholder="ุงูุทูู (ุณู)" class="w-full p-2 border rounded-md" required>
                            <input type="number" id="weight-input" placeholder="ุงููุฒู (ูุฌู)" class="w-full p-2 border rounded-md" required>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition">
                                ุญูุธ ุงูุจูุงูุงุช
                            </button>
                        </form>
                    </div>

                     <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-4">ุงูุฃูุฏุงู ุงูุนุงุฆููุฉ</h3>
                        <ul id="family-goals-list" class="space-y-2 mb-3 text-sm">
                           <!-- Goals will be dynamically inserted here -->
                        </ul>
                        <form id="goal-form" class="flex gap-2">
                            <input type="text" id="goal-input" placeholder="ุฃุถู ูุฏููุง ุฌุฏูุฏูุง..." class="flex-grow p-2 border rounded-md text-sm">
                            <button type="submit" class="bg-green-600 text-white p-2 rounded-md hover:bg-green-700 transition">
                                <i data-lucide="plus"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Right Panel: Charts -->
                <div class="lg:col-span-3 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                         <h3 class="text-xl font-bold mb-4">ูุฎุทุท ููู ุงูุจุทู</h3>
                         <p class="text-sm text-slate-500 mb-4">ูุฐุง ุงููุฎุทุท ูููุชุงุจุนุฉ ููุท. <strong class="text-red-600">ูุฌุจ ุฏุงุฆููุง ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ุงููุฎุชุต</strong> ูุชูุณูุฑ ุจูุงูุงุช ููู ุทููู.</p>
                         <div class="h-64"><canvas id="growthChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                            <h3 class="text-xl font-bold mb-2 sm:mb-0">ุฅุญุตุงุฆูุงุช ุงููุฌูู</h3>
                            <div class="p-1 bg-slate-100 rounded-full flex items-center text-sm space-x-1" dir="ltr">
                                <button data-period="daily" class="period-toggle-button font-semibold py-1 px-3 rounded-full">ูููู</button>
                                <button data-period="weekly" class="period-toggle-button active font-semibold py-1 px-3 rounded-full">ุฃุณุจูุนู</button>
                                <button data-period="monthly" class="period-toggle-button font-semibold py-1 px-3 rounded-full">ุดูุฑู</button>
                            </div>
                        </div>
                         <div class="h-64"><canvas id="starChart"></canvas></div>
                    </div>
                </div>
             </div>
        </main>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // 1. Import functions from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDZ7Ghq3QpWG4VRcM9m7dOdd07mSDDEhL4",
          authDomain: "rayan-143e0.firebaseapp.com",
          projectId: "rayan-143e0",
          storageBucket: "rayan-143e0.appspot.com",
          messagingSenderId: "597904651157",
          appId: "1:597904651157:web:3f6e907f145afb01bb3c9c",
          measurementId: "G-7H19VBC3PS"
        };

        // 3. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const childViewBtn = document.getElementById('child-view-btn');
        const parentViewBtn = document.getElementById('parent-view-btn');
        const childView = document.getElementById('child-view');
        const parentView = document.getElementById('parent-view');
        const starCountEl = document.getElementById('star-count');
        const questsContainer = document.getElementById('quests-container');
        const growthForm = document.getElementById('growth-form');
        const goalForm = document.getElementById('goal-form');
        const familyGoalsList = document.getElementById('family-goals-list');
        
        // --- APP STATE ---
        let userId, userDocRef;
        let growthChartInstance = null;
        let starChartInstance = null;
        let allQuestsData = [];
        let currentStarChartPeriod = 'weekly';

        // --- MAIN APP LOGIC ---
        async function main() {
            try {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await setupUser();
                        attachListeners();
                        loadingSpinner.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                    }
                });
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Initialization Error:", error);
                // THIS IS THE FIX: Display a user-friendly error message with instructions
                let friendlyMessage = '<p class="text-red-500 font-bold">ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุชุดุบูู ุงูุชุทุจูู. ูุฑุฌู ุชุญุฏูุซ ุงูุตูุญุฉ.</p>';
                if (error.code === 'auth/admin-restricted-operation') {
                    friendlyMessage = `
                        <div class="text-center p-4 bg-red-50 border border-red-200 rounded-lg max-w-lg">
                            <h4 class="font-bold text-red-700 text-lg mb-2">ุฎุทุฃ ูู ุฅุนุฏุงุฏุงุช Firebase</h4>
                            <p class="text-red-600">ูุจุฏู ุฃู ุทุฑููุฉ ุชุณุฌูู ุงูุฏุฎูู "ุงููุฌููู" (Anonymous) ุบูุฑ ููุนูุฉ.</p>
                            <p class="mt-4 text-sm text-slate-600">ูุญู ุงููุดููุฉุ ูุฑุฌู ุงุชุจุงุน ุงูุฎุทูุงุช ุงูุชุงููุฉ ูู ููุญุฉ ุชุญูู Firebase:</p>
                            <ol class="text-right list-decimal list-inside mt-2 space-y-1 text-sm bg-slate-50 p-3 rounded-md">
                                <li>ุงุฐูุจ ุฅูู ูุณู <strong>Build > Authentication</strong>.</li>
                                <li>ุงุฎุชุฑ ุชุจููุจ <strong>Sign-in method</strong>.</li>
                                <li>ุงุจุญุซ ุนู <strong>Anonymous</strong> ูู ุงููุงุฆูุฉ ูุงุถุบุท ุนูููุง.</li>
                                <li>ูู ุจุชูุนูููุง (Enable) ุซู ุงุถุบุท <strong>Save</strong>.</li>
                            </ol>
                            <p class="mt-4 text-xs text-slate-500">ุจุนุฏ ุชูุนูููุงุ ูู ุจุชุญุฏูุซ ูุฐู ุงูุตูุญุฉ.</p>
                        </div>
                    `;
                }
                loadingSpinner.innerHTML = friendlyMessage;
            }
        }
        
        async function setupUser() {
            const appId = 'hero-health-journey-prod'; // Using a consistent ID for production
            const docPath = `artifacts/${appId}/users/${userId}`;
            userDocRef = doc(db, docPath);
            const docSnap = await getDoc(userDocRef);

            if (!docSnap.exists()) {
                await setDoc(userDocRef, {
                    childName: "ุฑูุงู",
                    stars: 0,
                    avatar: "https://placehold.co/150x150/3B82F6/FFFFFF?text=ุฑูุงู",
                    createdAt: new Date()
                });
                const today = new Date().toISOString().split('T')[0];
                await setDoc(doc(db, `${docPath}/quests/${today}`), getInitialQuests());
                await addDoc(collection(db, `${docPath}/familyGoals`), { text: "ุชูุงูู ูุฌุจุฉ ุงูุนุดุงุก ูุนูุง", createdAt: new Date() });
                await addDoc(collection(db, `${docPath}/growthData`), { height: 140, weight: 55, date: new Date() });
            }
        }
        
        function getInitialQuests() {
             return { water: false, rainbow: false, activity: false, sleep: false, brave: false };
        }
        
        // --- UI & VIEW LOGIC ---
        childViewBtn.addEventListener('click', () => toggleView('child'));
        parentViewBtn.addEventListener('click', () => toggleView('parent'));

        function toggleView(view) {
            if (view === 'child') {
                childView.classList.remove('hidden'); parentView.classList.add('hidden');
                childViewBtn.classList.add('active'); parentViewBtn.classList.remove('active');
            } else {
                parentView.classList.remove('hidden'); childView.classList.add('hidden');
                parentViewBtn.classList.add('active'); childViewBtn.classList.remove('active');
            }
        }

        document.querySelectorAll('.period-toggle-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelector('.period-toggle-button.active').classList.remove('active');
                e.currentTarget.classList.add('active');
                currentStarChartPeriod = e.currentTarget.dataset.period;
                renderStarChart();
            });
        });

        // --- DATA RENDERING ---
        
        const questDetails = {
            rainbow: { title: 'ูููุฉ ููุณ ูุฒุญ ๐', html: 'ุชูุงูู <b>5 ุญุตุต ูุชููุนุฉ</b> ูู ุงูููุงูู ูุงูุฎุถุฑูุงุช ุจุฃููุงู ูุฎุชููุฉ ุฎูุงู ุงูููู.<br><br><b>ููุงุฐุงุ</b> ูู ููู ูุนุทู ุฌุณูู ููุชุงูููุงุช ููุนุงุฏู ูุฎุชููุฉ. ุชุฎูู ุฃูู ุชุจูู ุฏุฑุนูุง ููููุง ูุฌุณูู!<br><br><b>ูููุ</b><ul class="list-disc pr-5 text-right mt-2"><li><b>ุงูุฅูุทุงุฑ:</b> ุฃุถู ุดุฑุงุฆุญ ููุฒ ุฃู ุชูุช ุฅูู ุญุจูุจ ุงูุฅูุทุงุฑ.</li><li><b>ุงูุบุฏุงุก:</b> ุทุจู ุณูุทุฉ ุตุบูุฑ ูุน ุฎูุงุฑ ูุทูุงุทู ูุฌุฒุฑ.</li><li><b>ูุฌุจุฉ ุฎูููุฉ:</b> ุชูุงุญุฉ ุฃู ุจุฑุชูุงูุฉ.</li><li><b>ุงูุนุดุงุก:</b> ุงููููู ูู ุงูุจุฑูููู ุฃู ุงูุจุงุฒูุงุก ุจุฌุงูุจ ุงูุทุจู ุงูุฑุฆูุณู.</li></ul>' },
            water: { title: 'ุชุญุฏู ุงูุดูุงู ๐ง', html: 'ุงุดุฑุจ <b>6 ุฃููุงุจ ูู ุงููุงุก</b> ุนูู ุงูุฃูู ุฎูุงู ุงูููู.<br><br><b>ููุงุฐุงุ</b> ุงููุงุก ูู ูููุฏ ุงูุฏูุงุบ ูุงูุฌุณูุ ูุณุงุนุฏู ุนูู ุงูุชุฑููุฒ ูุงููุนุจ ุจูุดุงุท.<br><br><b>ูููุ</b> ูุง ุชุดุฑุจูุง ุฏูุนุฉ ูุงุญุฏุฉ! ูุฒุนูุง ุนูู ุงูููู:<ul class="list-disc pr-5 text-right mt-2"><li>ููุจ ุนูุฏ ุงูุงุณุชููุงุธ.</li><li>ููุจ ูุน ูู ูุฌุจุฉ ุฑุฆูุณูุฉ (ุฅูุทุงุฑุ ุบุฏุงุกุ ุนุดุงุก).</li><li>ููุจ ูุจู ูุจุนุฏ ุงููุนุจ ุฃู ููุงุฑุณุฉ ุงูุฑูุงุถุฉ.</li><li>ุงุฌุนู ุฒุฌุงุฌุฉ ุงููุงุก ุตุฏููุชู ุงูุฏุงุฆูุฉ!</li></ul>' },
            activity: { title: 'ุชุฏุฑูุจ ุงูุฃุจุทุงู ๐โโ๏ธ', html: 'ูุงุฑุณ <b>60 ุฏูููุฉ ูู ุงูุญุฑูุฉ ูุงููุนุจ</b> ุงููุดุท.<br><br><b>ููุงุฐุงุ</b> ุงูุญุฑูุฉ ุชููู ููุจู ูุนุถูุงุชู ูุนุธุงููุ ูุชุฌุนูู ุชุดุนุฑ ุจุงูุณุนุงุฏุฉ.<br><br><b>ูููุ</b> ููุณ ุจุงูุถุฑูุฑุฉ ุฃู ุชููู ุฑูุงุถุฉ ุฑุณููุฉ! ุฃู ุญุฑูุฉ ุชุนุชุจุฑ ุชุฏุฑูุจูุง:<ul class="list-disc pr-5 text-right mt-2"><li>ุงูุฌุฑู ูู ุงูุญุฏููุฉ ุฃู ุงููุนุจ ุจุงููุฑุฉ.</li><li>ุฑููุจ ุงูุฏุฑุงุฌุฉ ุฃู ุงูุณููุชุฑ.</li><li>ุงูููุฒ ุนูู ุงูุญุจู ุฃู ุงูุฑูุต ุนูู ุฃุบุงููู ุงูููุถูุฉ.</li><li>ูุณุงุนุฏุฉ ุงูุฃูู ูู ุฃุนูุงู ุงูููุฒู ุงูุชู ุชุชุทูุจ ุญุฑูุฉ.</li></ul>' },
            sleep: { title: 'ุดุญู ุงูุทุงูุฉ ๐ด', html: 'ูู ููุฏุฉ <b>9 ุฅูู 11 ุณุงุนุฉ</b> ูู ูููุฉ.<br><br><b>ููุงุฐุงุ</b> ุฃุซูุงุก ุงููููุ ูููู ุฌุณูู ุจุฅุตูุงุญ ููุณู ูุชููู ุนุถูุงุชู ููุฎุฒู ุฏูุงุบู ูุง ุชุนููุชู. ุฅูู ูุซู ุดุญู ุจุทุงุฑูุฉ ุจุทูู ุงูุฎุงุฑู!<br><br><b>ูููุ</b><ul class="list-disc pr-5 text-right mt-2"><li>ุญุฏุฏ ููุนุฏูุง ุซุงุจุชูุง ููููู ูู ููู.</li><li>ุงุจุชุนุฏ ุนู ุงูุดุงุดุงุช (ุชููุฒูููุ ุชุงุจูุช) ูุจู ุณุงุนุฉ ูู ุงูููู.</li><li>ุงุฌุนู ุบุฑูุฉ ูููู ูุงุฏุฆุฉ ููุธููุฉ.</li></ul>' },
            brave: { title: 'ุงููุณุชูุดู ุงูุดุฌุงุน ๐ฅ', html: 'ุฌุฑุจ <b>ุทุนุงููุง ุตุญููุง ุฌุฏูุฏูุง</b> ูู ุชูู ุชุนุฑูู.<br><br><b>ููุงุฐุงุ</b> ุงุณุชูุดุงู ุฃุทุนูุฉ ุฌุฏูุฏุฉ ููุณุน ูุงุฆูุฉ ุทุนุงู ุงูููุฉ ูุฏููุ ููุฏ ุชูุชุดู ุทุนุงูู ุงูููุถู ุงูุฌุฏูุฏ!<br><br><b>ูููุ</b><ul class="list-disc pr-5 text-right mt-2"><li>ุงุทูุจ ูู ุงูุฃูู ุงุฎุชูุงุฑ ููุน ุฎุถุงุฑ ุฃู ูุงููุฉ ุฌุฏูุฏ ุนูุฏ ุงูุชุณูู.</li><li>ุฌุฑุจ ูุถูุฉ ุตุบูุฑุฉ ููุทุ ูุง ุจุฃุณ ุฅุฐุง ูู ุชุนุฌุจู ูู ุฃูู ูุฑุฉ.</li><li>ููููู ูุณุงุนุฏุฉ ุงูุฃูู ูู ุชุญุถูุฑูุง ูุชุดุนุฑ ุจุงูุญูุงุณ ูุชุฌุฑุจุชูุง.</li></ul>' },
        };
        
        function renderQuests(questsData, date) {
            const quests = [
                { id: 'rainbow', title: 'ูููุฉ ููุณ ูุฒุญ', icon: 'carrot', color: 'orange'},
                { id: 'water', title: 'ุชุญุฏู ุงูุดูุงู', icon: 'glass-water', color: 'blue'},
                { id: 'activity', title: 'ุชุฏุฑูุจ ุงูุฃุจุทุงู', icon: 'bike', color: 'green'},
                { id: 'sleep', title: 'ุดุญู ุงูุทุงูุฉ', icon: 'bed-double', color: 'indigo'},
                { id: 'brave', title: 'ุงููุณุชูุดู ุงูุดุฌุงุน', icon: 'gem', color: 'rose'},
            ];
            questsContainer.innerHTML = '';
            quests.forEach(quest => {
                const isCompleted = questsData[quest.id];
                const card = document.createElement('div');
                card.className = `quest-card border-2 rounded-2xl p-4 flex items-center gap-4 transition-all ${isCompleted ? 'completed' : 'bg-white'}`;
                card.innerHTML = `
                    <div class="quest-icon bg-${quest.color}-100 text-${quest.color}-600 w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0">
                        <i data-lucide="${quest.icon}" class="w-8 h-8"></i>
                    </div>
                    <div><h4 class="font-bold text-lg">${quest.title}</h4></div>
                `;
                card.onclick = () => showQuestDetails(quest.id, isCompleted, date);
                questsContainer.appendChild(card);
            });
            lucide.createIcons();
        }

        function showQuestDetails(questId, isCompleted, date) {
            const details = questDetails[questId];
            Swal.fire({
                title: details.title,
                html: details.html,
                icon: 'info',
                iconColor: '#3B82F6',
                confirmButtonText: isCompleted ? 'ุฅูุบุงุก ุฅูุฌุงุฒ ุงููููุฉ' : 'ููุฏ ุฃูุฌุฒุช ุงููููุฉ!',
                confirmButtonColor: isCompleted ? '#EF4444' : '#16A34A',
                showCancelButton: true,
                cancelButtonText: 'ุฅุบูุงู',
            }).then((result) => {
                if (result.isConfirmed) {
                    handleQuestClick(questId, !isCompleted, date);
                }
            });
        }
        
        // --- Star Chart Logic ---
        function renderStarChart() {
            const ctx = document.getElementById('starChart').getContext('2d');
            if (starChartInstance) starChartInstance.destroy();
            
            const { labels, data } = aggregateStarsByPeriod(allQuestsData, currentStarChartPeriod);

            starChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ุงููุฌูู ุงูููุชุณุจุฉ',
                        data: data,
                        backgroundColor: 'rgba(251, 191, 36, 0.6)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function aggregateStarsByPeriod(quests, period) {
            const starsPerQuest = 10;
            const dailyStars = {};
            quests.forEach(q => {
                const completedCount = Object.values(q.data).filter(Boolean).length;
                dailyStars[q.id] = completedCount * starsPerQuest;
            });

            const today = new Date();
            const labels = [];
            const data = [];
            
            if (period === 'daily') {
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateString = d.toISOString().split('T')[0];
                    labels.push(d.toLocaleDateString('ar-EG', { weekday: 'short' }));
                    data.push(dailyStars[dateString] || 0);
                }
            } else if (period === 'weekly') {
                for (let i = 3; i >= 0; i--) {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() - (i * 7));
                    const weekStart = new Date(weekEnd);
                    weekStart.setDate(weekStart.getDate() - 6);
                    
                    labels.push(`ุฃุณุจูุน ${4-i}`);
                    let weekTotal = 0;
                    Object.keys(dailyStars).forEach(dateStr => {
                        const d = new Date(dateStr);
                        d.setHours(0,0,0,0);
                        const start = new Date(weekStart);
                        start.setHours(0,0,0,0);
                         const end = new Date(weekEnd);
                        end.setHours(0,0,0,0);

                        if (d >= start && d <= end) {
                            weekTotal += dailyStars[dateStr];
                        }
                    });
                    data.push(weekTotal);
                }
            } else if (period === 'monthly') {
                 for (let i = 5; i >= 0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    labels.push(d.toLocaleDateString('ar-EG', { month: 'long' }));
                    let monthTotal = 0;
                     Object.keys(dailyStars).forEach(dateStr => {
                        if (dateStr.startsWith(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`)) {
                           monthTotal += dailyStars[dateStr];
                        }
                    });
                    data.push(monthTotal);
                }
            }
            return { labels, data };
        }
        
        // --- FIRESTORE INTERACTIONS ---
        async function handleQuestClick(questId, completed, date) {
            const questDocRef = doc(db, `${userDocRef.path}/quests/${date}`);
            const increment = completed ? 10 : -10;
            const docSnap = await getDoc(userDocRef);
            const currentStars = docSnap.data().stars;

            await updateDoc(questDocRef, { [questId]: completed });
            await updateDoc(userDocRef, { stars: Math.max(0, currentStars + increment) });

            if(completed) {
                 Swal.fire({
                    toast: true,
                    position: 'top-start',
                    icon: 'success',
                    title: 'ุฑุงุฆุน ูุง ุจุทู! +10 ูุฌูู',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        }
        
        growthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const height = document.getElementById('height-input').value;
            const weight = document.getElementById('weight-input').value;
            if (height && weight) {
                await addDoc(collection(db, `${userDocRef.path}/growthData`), {
                    height: parseFloat(height),
                    weight: parseFloat(weight),
                    date: new Date()
                });
                growthForm.reset();
                 Swal.fire('ุชู ุงูุญูุธ', 'ุชู ุญูุธ ุจูุงูุงุช ุงูููู ุจูุฌุงุญ.', 'success');
            }
        });

        goalForm.addEventListener('submit', async(e) => {
            e.preventDefault();
            const goalInput = document.getElementById('goal-input');
            const goalText = goalInput.value.trim();
            if(goalText) {
                await addDoc(collection(db, `${userDocRef.path}/familyGoals`), {
                    text: goalText,
                    createdAt: new Date()
                });
                goalInput.value = '';
            }
        });
        
        async function deleteFamilyGoal(goalId) {
             await deleteDoc(doc(db, `${userDocRef.path}/familyGoals/${goalId}`));
        }
        
        // --- REALTIME LISTENERS ---
        let unsubscribes = [];
        function attachListeners() {
            unsubscribes.forEach(unsub => unsub()); // Clear previous listeners
            unsubscribes = [];

            // Listen to main user document
            const unsubUser = onSnapshot(userDocRef, (doc) => {
                const data = doc.data();
                if (!data) return;
                document.getElementById('child-name').textContent = data.childName;
                document.getElementById('avatar-img').src = data.avatar;
                starCountEl.textContent = data.stars;
            });

            // Listen to today's quests
            const today = new Date().toISOString().split('T')[0];
            const questDocRef = doc(db, `${userDocRef.path}/quests/${today}`);
            const unsubTodayQuests = onSnapshot(questDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    renderQuests(docSnap.data(), today);
                } else {
                    await setDoc(questDocRef, getInitialQuests());
                }
            });

            // Listen to all quests for star chart
            const questsQuery = query(collection(db, `${userDocRef.path}/quests`));
            const unsubAllQuests = onSnapshot(questsQuery, (snapshot) => {
                allQuestsData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                renderStarChart();
            });

            // Re-use rendering functions for other listeners
            const growthQuery = query(collection(db, `${userDocRef.path}/growthData`));
            const unsubGrowth = onSnapshot(growthQuery, (snapshot) => renderGrowthChart(snapshot.docs.map(d => d.data())));

            const goalsQuery = query(collection(db, `${userDocRef.path}/familyGoals`));
            const unsubGoals = onSnapshot(goalsQuery, (snapshot) => renderFamilyGoals(snapshot.docs.map(d => ({id: d.id, ...d.data()}))));

            unsubscribes.push(unsubUser, unsubTodayQuests, unsubAllQuests, unsubGrowth, unsubGoals);
        }

        function renderGrowthChart(growthData) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const sortedData = growthData.sort((a,b) => a.date.seconds - b.date.seconds);
            const labels = sortedData.map(d => new Date(d.date.seconds * 1000).toLocaleDateString('ar-EG'));
            const weightData = sortedData.map(d => d.weight);
            const heightData = sortedData.map(d => d.height);
            
            if(growthChartInstance) growthChartInstance.destroy();

            growthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ุงููุฒู (ูุฌู)', data: weightData, borderColor: 'rgb(59, 130, 246)', yAxisID: 'y' },
                        { label: 'ุงูุทูู (ุณู)', data: heightData, borderColor: 'rgb(234, 88, 12)', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { position: 'right', title: { display: true, text: 'ุงููุฒู (ูุฌู)' } },
                        y1: { position: 'left', title: { display: true, text: 'ุงูุทูู (ุณู)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
        
        function renderFamilyGoals(goals) {
            familyGoalsList.innerHTML = '';
            if (goals.length === 0) {
                familyGoalsList.innerHTML = `<li class="text-slate-500">ูุง ุชูุฌุฏ ุฃูุฏุงู ุญุงููุฉ.</li>`;
                return;
            }
            goals.forEach(goal => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-white p-2 rounded-md shadow-sm';
                li.innerHTML = `
                    <span>${goal.text}</span>
                    <button data-id="${goal.id}" class="delete-goal-btn text-red-500 hover:text-red-700">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                familyGoalsList.appendChild(li);
            });
            document.querySelectorAll('.delete-goal-btn').forEach(btn => {
                btn.onclick = (e) => deleteFamilyGoal(e.currentTarget.getAttribute('data-id'));
            });
            lucide.createIcons();
        }

        // --- START THE APP ---
        main();

    </script>
</body>
</html>
